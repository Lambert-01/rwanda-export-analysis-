<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rwanda Export Explorer | AI-Powered Trade Analytics</title>

    <!-- Meta Tags -->
    <meta name="description" content="Advanced Rwanda trade analytics with AI-powered insights, interactive visualizations, and comprehensive data analysis">
    <meta name="keywords" content="Rwanda, exports, imports, trade, NISR, AI, analytics, visualization, forecasting">
    <meta name="author" content="Rwanda Export Explorer - AI Enhanced">

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="assets/images/favicon.ico">

    <!-- External Libraries CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="stylesheet" href="css/index.css">
</head>
<body>
    <!-- Modern Sidebar Navigation -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo-container">
                <img src="assets/images/NISR.png" alt="NISR Logo" class="nisr-logo">
                <h3>Rwanda Export Explorer</h3>
                <span class="ai-badge">AI-Powered</span>
            </div>
        </div>

        <div class="sidebar-menu">
            <ul class="nav-list">
                <li class="nav-item">
                    <a href="index.html" class="nav-link active" data-page="dashboard">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                        <div class="nav-indicator"></div>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="exports.html" class="nav-link" data-page="exports">
                        <i class="fas fa-arrow-up"></i>
                        <span>Exports</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="imports.html" class="nav-link" data-page="imports">
                        <i class="fas fa-arrow-down"></i>
                        <span>Imports</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="predictions.html" class="nav-link" data-page="predictions">
                        <i class="fas fa-robot"></i>
                        <span>AI Predictions</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="analytics.html" class="nav-link" data-page="analytics">
                        <i class="fas fa-chart-line"></i>
                        <span>Advanced Analytics</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="commodities.html" class="nav-link" data-page="commodities">
                        <i class="fas fa-boxes"></i>
                        <span>Commodities</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="regional.html" class="nav-link" data-page="regional">
                        <i class="fas fa-globe-africa"></i>
                        <span>Regional Analysis</span>
                    </a>
                </li>
            </ul>
        </div>

        <div class="sidebar-footer">
            <div class="user-info">
                <div class="user-avatar">
                    <i class="fas fa-user-circle"></i>
                </div>
                <div class="user-details">
                    <span class="user-name">Trade Analyst</span>
                    <span class="user-role">NISR Dashboard</span>
                </div>
            </div>
            <div class="sidebar-footer-compact">
                <div class="footer-info">
                    <span class="footer-copyright">© 2024 Rwanda Export Explorer</span>
                    <span class="footer-meta">Data: NISR | Updated: 2025-01-05</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Mobile Overlay -->
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <!-- Top Header Bar -->
    <header class="top-header">
        <div class="header-left">
            <button class="sidebar-toggle" id="sidebar-toggle" title="Toggle Navigation Menu" aria-label="Toggle Navigation Menu">
                <i class="fas fa-bars"></i>
            </button>
            <div class="page-title">
                <h1>Trade Analytics Dashboard</h1>
                <p>Real-time insights and AI-powered analysis</p>
            </div>
        </div>

        <div class="header-right">
            <div class="header-actions">
                <button class="btn btn-refresh" onclick="loadRealTradeData()" title="Refresh Data">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <button class="btn btn-notifications" onclick="toggleNotifications()" title="Notifications">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge">3</span>
                </button>
                <div class="time-display">
                    <i class="fas fa-clock"></i>
                    <span id="current-time">Loading...</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Loading Screen -->
        <div id="loading-screen" class="loading-screen">
            <div class="spinner-container">
                <div class="spinner"></div>
                <p class="loading-text">Loading Rwanda Trade Data...</p>
                <div class="mt-3">
                    <small class="text-white-50">Initializing AI-powered analytics...</small>
                </div>
            </div>
        </div>

        <!-- Dashboard Overview -->
        <section id="dashboard" class="section active">
            <!-- Modern Hero Section -->
            <div class="hero-section">
                <div class="container-fluid">
                    <div class="row align-items-center">
                        <div class="col-lg-8">
                            <div class="hero-content">
                                <h1 class="hero-title">
                                    <span class="flag">🇷🇼</span>
                                    Rwanda Trade Intelligence
                                </h1>
                                <p class="hero-subtitle">
                                    Advanced AI-powered analytics platform for Rwanda's trade ecosystem
                                </p>
                                <div class="hero-stats-grid">
                                    <div class="hero-stat-card">
                                        <div class="stat-icon">
                                            <i class="fas fa-dollar-sign"></i>
                                        </div>
                                        <div class="stat-info">
                                            <span class="stat-number" id="total-trade-value">$11.32B</span>
                                            <span class="stat-label">Total Trade Volume</span>
                                        </div>
                                    </div>
                                    <div class="hero-stat-card">
                                        <div class="stat-icon growth">
                                            <i class="fas fa-chart-line"></i>
                                        </div>
                                        <div class="stat-info">
                                            <span class="stat-number growth-positive" id="export-growth">+157.9%</span>
                                            <span class="stat-label">Export Growth</span>
                                        </div>
                                    </div>
                                    <div class="hero-stat-card">
                                        <div class="stat-icon">
                                            <i class="fas fa-globe"></i>
                                        </div>
                                        <div class="stat-info">
                                            <span class="stat-number" id="active-partners">134</span>
                                            <span class="stat-label">Trading Partners</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="hero-visual">
                                <div class="ai-assistant-card">
                                    <div class="ai-avatar">
                                        <i class="fas fa-robot"></i>
                                    </div>
                                    <div class="ai-info">
                                        <h4>AI Assistant</h4>
                                        <p>Ready to help with your analysis</p>
                                        <button class="btn btn-primary btn-sm" onclick="toggleChatbox()">
                                            <i class="fas fa-comments"></i>
                                            Ask AI
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modern Stats Cards -->
            <div class="container-fluid">
                <div class="row g-4 mb-5" id="main-stats-cards">
                    <div class="col-lg-3 col-md-6">
                        <div class="modern-stats-card" data-aos="fade-up" data-aos-delay="100">
                            <div class="card-header">
                                <div class="card-icon success">
                                    <i class="fas fa-arrow-trend-up"></i>
                                </div>
                                <div class="card-badge">
                                    <i class="fas fa-arrow-up"></i>
                                    <span id="exports-trend">+157.9%</span>
                                </div>
                            </div>
                            <div class="card-content">
                                <h3 class="card-value" id="exports-value">$8.94B</h3>
                                <p class="card-label">Total Exports</p>
                                <div class="card-subtitle">2022-2025 Cumulative</div>
                            </div>
                            <div class="card-footer">
                                <div class="trend-indicator positive">
                                    <i class="fas fa-arrow-up"></i>
                                    <span>Strong Growth</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-3 col-md-6">
                        <div class="modern-stats-card" data-aos="fade-up" data-aos-delay="200">
                            <div class="card-header">
                                <div class="card-icon primary">
                                    <i class="fas fa-arrow-trend-down"></i>
                                </div>
                                <div class="card-badge">
                                    <i class="fas fa-arrow-up"></i>
                                    <span id="imports-trend">+78.0%</span>
                                </div>
                            </div>
                            <div class="card-content">
                                <h3 class="card-value" id="imports-value">$20.26B</h3>
                                <p class="card-label">Total Imports</p>
                                <div class="card-subtitle">2022-2025 Cumulative</div>
                            </div>
                            <div class="card-footer">
                                <div class="trend-indicator positive">
                                    <i class="fas fa-arrow-up"></i>
                                    <span>Increasing Demand</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-3 col-md-6">
                        <div class="modern-stats-card" data-aos="fade-up" data-aos-delay="300">
                            <div class="card-header">
                                <div class="card-icon warning">
                                    <i class="fas fa-exchange-alt"></i>
                                </div>
                                <div class="card-badge">
                                    <i class="fas fa-arrow-up"></i>
                                    <span id="reexports-trend">+45.2%</span>
                                </div>
                            </div>
                            <div class="card-content">
                                <h3 class="card-value" id="reexports-value">$1.24B</h3>
                                <p class="card-label">Re-exports</p>
                                <div class="card-subtitle">Transit Trade Volume</div>
                            </div>
                            <div class="card-footer">
                                <div class="trend-indicator positive">
                                    <i class="fas fa-arrow-up"></i>
                                    <span>Growing Hub</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-3 col-md-6">
                        <div class="modern-stats-card" data-aos="fade-up" data-aos-delay="400">
                            <div class="card-header">
                                <div class="card-icon danger">
                                    <i class="fas fa-balance-scale"></i>
                                </div>
                                <div class="card-badge negative">
                                    <i class="fas fa-arrow-down"></i>
                                    <span id="balance-trend">Deficit</span>
                                </div>
                            </div>
                            <div class="card-content">
                                <h3 class="card-value" id="balance-value">-$11.32B</h3>
                                <p class="card-label">Trade Balance</p>
                                <div class="card-subtitle">Export-Import Gap</div>
                            </div>
                            <div class="card-footer">
                                <div class="trend-indicator negative">
                                    <i class="fas fa-arrow-down"></i>
                                    <span>Trade Deficit</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modern Charts Section -->
                <div class="row g-4 mb-5" id="main-charts">
                    <div class="col-lg-8">
                        <div class="chart-card modern-chart-card" data-aos="fade-right" data-aos-delay="200">
                            <div class="chart-header">
                                <div class="chart-title-section">
                                    <h3 class="chart-title">
                                        <i class="fas fa-chart-line me-2"></i>Trade Performance Trends
                                    </h3>
                                    <p class="chart-subtitle">Export and Import volume analysis over time</p>
                                </div>
                                <div class="chart-controls">
                                    <div class="btn-group">
                                        <button class="btn btn-outline-primary active" data-chart="quarterly">Quarterly</button>
                                        <button class="btn btn-outline-primary" data-chart="yearly">Yearly</button>
                                    </div>
                                    <button class="btn btn-success" onclick="refreshCharts()">
                                        <i class="fas fa-sync-alt me-1"></i>Refresh
                                    </button>
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="trade-performance-chart" height="320"></canvas>
                            </div>
                            <div class="chart-footer">
                                <div class="chart-insights">
                                    <div class="insight-item">
                                        <i class="fas fa-lightbulb text-warning"></i>
                                        <span>Export growth trending upward</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-4">
                        <div class="chart-card modern-chart-card" data-aos="fade-left" data-aos-delay="300">
                            <div class="chart-header">
                                <div class="chart-title-section">
                                    <h3 class="chart-title">
                                        <i class="fas fa-balance-scale me-2"></i>Trade Balance Analysis
                                    </h3>
                                    <p class="chart-subtitle">Net trade position and trends</p>
                                </div>
                                <div class="ai-badge">
                                    <i class="fas fa-robot"></i>AI Analysis
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="trade-balance-chart" height="320"></canvas>
                            </div>
                            <div class="chart-footer">
                                <div class="balance-indicator">
                                    <span class="balance-status deficit">Current Deficit</span>
                                    <span class="balance-value">-$11.32B</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analytics Cards Row -->
                <div class="row g-4 mb-5" id="additional-analytics">
                    <div class="col-lg-6">
                        <div class="chart-card modern-chart-card" data-aos="fade-up" data-aos-delay="400">
                            <div class="chart-header">
                                <div class="chart-title-section">
                                    <h3 class="chart-title">
                                        <i class="fas fa-chart-pie me-2"></i>Export Distribution
                                    </h3>
                                    <p class="chart-subtitle">Top export destinations by volume</p>
                                </div>
                                <div class="chart-badge">
                                    <i class="fas fa-globe"></i>
                                    20 Countries
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="export-distribution-chart" height="280"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-6">
                        <div class="chart-card modern-chart-card" data-aos="fade-up" data-aos-delay="500">
                            <div class="chart-header">
                                <div class="chart-title-section">
                                    <h3 class="chart-title">
                                        <i class="fas fa-chart-bar me-2"></i>Commodity Analysis
                                    </h3>
                                    <p class="chart-subtitle">Performance by product categories</p>
                                </div>
                                <div class="chart-badge">
                                    <i class="fas fa-boxes"></i>
                                    Top Categories
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="commodity-performance-chart" height="280"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions & Recent Activity -->
                <div class="row g-4 mb-5">
                    <div class="col-lg-8">
                        <div class="chart-card modern-card" data-aos="fade-up" data-aos-delay="600">
                            <div class="chart-header">
                                <div class="chart-title-section">
                                    <h3 class="chart-title">
                                        <i class="fas fa-rocket me-2"></i>Quick Actions
                                    </h3>
                                    <p class="chart-subtitle">Navigate to detailed analysis sections</p>
                                </div>
                            </div>
                            <div class="quick-actions-grid">
                                <a href="exports.html" class="quick-action-btn modern" data-aos="zoom-in" data-aos-delay="650">
                                    <div class="action-icon">
                                        <i class="fas fa-arrow-up"></i>
                                    </div>
                                    <div class="action-content">
                                        <span class="action-title">Export Analysis</span>
                                        <span class="action-desc">Detailed export trends & insights</span>
                                    </div>
                                    <div class="action-arrow">
                                        <i class="fas fa-chevron-right"></i>
                                    </div>
                                </a>
                                <a href="imports.html" class="quick-action-btn modern" data-aos="zoom-in" data-aos-delay="700">
                                    <div class="action-icon">
                                        <i class="fas fa-arrow-down"></i>
                                    </div>
                                    <div class="action-content">
                                        <span class="action-title">Import Analysis</span>
                                        <span class="action-desc">Import patterns & sources</span>
                                    </div>
                                    <div class="action-arrow">
                                        <i class="fas fa-chevron-right"></i>
                                    </div>
                                </a>
                                <a href="predictions.html" class="quick-action-btn modern" data-aos="zoom-in" data-aos-delay="750">
                                    <div class="action-icon">
                                        <i class="fas fa-robot"></i>
                                    </div>
                                    <div class="action-content">
                                        <span class="action-title">AI Predictions</span>
                                        <span class="action-desc">Machine learning forecasts</span>
                                    </div>
                                    <div class="action-arrow">
                                        <i class="fas fa-chevron-right"></i>
                                    </div>
                                </a>
                                <a href="analytics.html" class="quick-action-btn modern" data-aos="zoom-in" data-aos-delay="800">
                                    <div class="action-icon">
                                        <i class="fas fa-chart-line"></i>
                                    </div>
                                    <div class="action-content">
                                        <span class="action-title">Advanced Analytics</span>
                                        <span class="action-desc">Deep statistical analysis</span>
                                    </div>
                                    <div class="action-arrow">
                                        <i class="fas fa-chevron-right"></i>
                                    </div>
                                </a>
                                <a href="regional.html" class="quick-action-btn modern" data-aos="zoom-in" data-aos-delay="850">
                                    <div class="action-icon">
                                        <i class="fas fa-globe-africa"></i>
                                    </div>
                                    <div class="action-content">
                                        <span class="action-title">Regional Analysis</span>
                                        <span class="action-desc">Geographic trade patterns</span>
                                    </div>
                                    <div class="action-arrow">
                                        <i class="fas fa-chevron-right"></i>
                                    </div>
                                </a>
                                <a href="commodities.html" class="quick-action-btn modern" data-aos="zoom-in" data-aos-delay="900">
                                    <div class="action-icon">
                                        <i class="fas fa-boxes"></i>
                                    </div>
                                    <div class="action-content">
                                        <span class="action-title">Commodity Analysis</span>
                                        <span class="action-desc">Product category insights</span>
                                    </div>
                                    <div class="action-arrow">
                                        <i class="fas fa-chevron-right"></i>
                                    </div>
                                </a>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-4">
                        <div class="chart-card modern-card" data-aos="fade-up" data-aos-delay="600">
                            <div class="chart-header">
                                <div class="chart-title-section">
                                    <h3 class="chart-title">
                                        <i class="fas fa-clock me-2"></i>Recent Activity
                                    </h3>
                                    <p class="chart-subtitle">Latest system updates</p>
                                </div>
                            </div>
                            <div class="activity-feed">
                                <div class="activity-item">
                                    <div class="activity-icon">
                                        <i class="fas fa-chart-line text-success"></i>
                                    </div>
                                    <div class="activity-content">
                                        <span class="activity-text">Export data updated</span>
                                        <span class="activity-time">2 minutes ago</span>
                                    </div>
                                </div>
                                <div class="activity-item">
                                    <div class="activity-icon">
                                        <i class="fas fa-robot text-primary"></i>
                                    </div>
                                    <div class="activity-content">
                                        <span class="activity-text">AI analysis completed</span>
                                        <span class="activity-time">15 minutes ago</span>
                                    </div>
                                </div>
                                <div class="activity-item">
                                    <div class="activity-icon">
                                        <i class="fas fa-database text-info"></i>
                                    </div>
                                    <div class="activity-content">
                                        <span class="activity-text">New data imported</span>
                                        <span class="activity-time">1 hour ago</span>
                                    </div>
                                </div>
                                <div class="activity-item">
                                    <div class="activity-icon">
                                        <i class="fas fa-bell text-warning"></i>
                                    </div>
                                    <div class="activity-content">
                                        <span class="activity-text">Trade alert triggered</span>
                                        <span class="activity-time">3 hours ago</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Market Intelligence Section -->
                <div class="row g-4 mb-5">
                    <div class="col-lg-12">
                        <div class="chart-card modern-card market-intel-card" data-aos="fade-up" data-aos-delay="700">
                            <div class="chart-header">
                                <div class="chart-title-section">
                                    <h3 class="chart-title">
                                        <i class="fas fa-brain me-2"></i>Market Intelligence
                                    </h3>
                                    <p class="chart-subtitle">AI-powered insights and recommendations</p>
                                </div>
                                <div class="intel-actions">
                                    <button class="btn btn-primary" onclick="generateInsights()">
                                        <i class="fas fa-lightbulb me-1"></i>Generate Insights
                                    </button>
                                    <button class="btn btn-outline-primary" onclick="toggleChatbox()">
                                        <i class="fas fa-comments me-1"></i>Ask AI Assistant
                                    </button>
                                </div>
                            </div>
                            <div class="intel-content">
                                <div class="insights-grid">
                                    <div class="insight-card">
                                        <div class="insight-icon">
                                            <i class="fas fa-trending-up text-success"></i>
                                        </div>
                                        <div class="insight-content">
                                            <h4>Export Opportunities</h4>
                                            <p>Identified 5 high-potential markets for expansion</p>
                                            <span class="insight-tag positive">+23% Potential</span>
                                        </div>
                                    </div>
                                    <div class="insight-card">
                                        <div class="insight-icon">
                                            <i class="fas fa-exclamation-triangle text-warning"></i>
                                        </div>
                                        <div class="insight-content">
                                            <h4>Risk Alert</h4>
                                            <p>Supply chain disruption detected in key commodities</p>
                                            <span class="insight-tag warning">Monitor</span>
                                        </div>
                                    </div>
                                    <div class="insight-card">
                                        <div class="insight-icon">
                                            <i class="fas fa-chart-pie text-info"></i>
                                        </div>
                                        <div class="insight-content">
                                            <h4>Market Shift</h4>
                                            <p>Consumer preferences changing in agricultural sector</p>
                                            <span class="insight-tag info">Adaptation Needed</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Export vs Import Comparison Section -->
                <div class="row g-4 mb-5">
                    <div class="col-lg-12">
                        <div class="chart-card modern-card" data-aos="fade-up" data-aos-delay="800">
                            <div class="chart-header">
                                <div class="chart-title-section">
                                    <h3 class="chart-title">
                                        <i class="fas fa-balance-scale me-2"></i>Export vs Import Comparison
                                    </h3>
                                    <p class="chart-subtitle">Compare export and import trends across different dimensions</p>
                                </div>
                                <div class="comparison-controls">
                                    <div class="comparison-form" style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                                        <div>
                                            <label for="comparison-period" style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.25rem; color: var(--text-secondary);">Select Period</label>
                                            <select class="form-select" id="comparison-period" style="width: auto; min-width: 120px;">
                                                <option value="q4_2024" selected>Q4 2024</option>
                                                <option value="q3_2024">Q3 2024</option>
                                                <option value="q2_2024">Q2 2024</option>
                                                <option value="q1_2024">Q1 2024</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="comparison-type" style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.25rem; color: var(--text-secondary);">Select Comparison Type</label>
                                            <select class="form-select" id="comparison-type" style="width: auto; min-width: 150px;">
                                                <option value="countries" selected>By Countries</option>
                                                <option value="commodities">By Commodities</option>
                                                <option value="regions">By Regions</option>
                                            </select>
                                        </div>
                                        <div style="margin-left: auto;">
                                            <button class="btn btn-primary" onclick="generateComparison()" style="margin-top: 1.5rem;">
                                                <i class="fas fa-chart-bar me-1"></i>Generate Comparison
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="comparison-results" id="comparison-results" style="min-height: 400px; display: block !important; visibility: visible !important; opacity: 1 !important;">
                                <div class="comparison-placeholder" id="comparison-placeholder">
                                    <i class="fas fa-balance-scale fa-3x mb-3" style="color: var(--rwanda-blue);"></i>
                                    <p>Select comparison parameters and click "Generate Comparison" to see detailed export vs import analysis.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- AI Chatbox -->
    <div class="ai-chatbox" id="ai-chatbox">
        <div class="chatbox-header">
            <div class="chatbox-title">
                <div class="ai-avatar small">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="chatbox-info">
                    <h4>AI Trade Assistant</h4>
                    <span class="status online">Online</span>
                </div>
            </div>
            <div class="chatbox-controls">
                <button class="btn btn-settings" onclick="openAISettings()" title="AI Settings">
                    <i class="fas fa-cog"></i>
                </button>
                <button class="btn btn-minimize" onclick="minimizeChatbox()" title="Minimize">
                    <i class="fas fa-minus"></i>
                </button>
                <button class="btn btn-close" onclick="closeChatbox()" title="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>

        <div class="chatbox-body">
            <div class="chat-messages" id="chat-messages">
                <div class="message ai-message">
                    <div class="message-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="message-content">
                        <div class="message-text">
                            Hello! I'm your AI Trade Assistant. I can help you analyze Rwanda's trade data, identify trends, and provide insights. What would you like to know?
                        </div>
                        <div class="message-time">Just now</div>
                    </div>
                </div>
            </div>

            <div class="chat-input-container">
                <div class="chat-input-area">
                    <input type="text" class="chat-input" id="chat-input" placeholder="Ask me about trade data, trends, or insights...">
                    <button class="btn btn-send" onclick="sendMessage()" title="Send Message">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <div class="chat-suggestions">
                    <button class="suggestion-btn" onclick="askQuestion('What are the top export commodities?')">Top Exports</button>
                    <button class="suggestion-btn" onclick="askQuestion('Show me trade balance trends')">Trade Balance</button>
                    <button class="suggestion-btn" onclick="askQuestion('What are the main trading partners?')">Trading Partners</button>
                    <button class="suggestion-btn" onclick="askQuestion('Predict future export trends')">Future Predictions</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Chatbox Toggle Button -->
    <button class="chatbox-toggle" id="chatbox-toggle" onclick="toggleChatbox()" title="Open AI Assistant">
        <i class="fas fa-comments"></i>
        <span class="notification-dot"></span>
    </button>

    <!-- AI Settings Modal -->
    <div class="ai-settings-modal" id="ai-settings-modal">
        <div class="settings-modal-content">
            <div class="settings-header">
                <h3>
                    <i class="fas fa-cog me-2"></i>AI Assistant Settings
                </h3>
                <button class="settings-close" onclick="closeAISettings()" title="Close Settings">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="settings-body">
                <div class="settings-section">
                    <h4>OpenRouter / DeepSeek V1 Configuration</h4>
                    <p class="settings-description">
                        Your system is configured with DeepSeek V1 through OpenRouter! This provides powerful AI
                        capabilities for intelligent trade analysis and insights. The API key is already set in your .env file.
                    </p>

                    <div class="api-status connected" id="api-status">
                        <div class="status-indicator">
                            <span class="status-dot connected"></span>
                            <span class="status-text">✅ DeepSeek V1 Connected</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="openai-api-key">OpenAI API Key</label>
                        <input type="password" id="openai-api-key" placeholder="sk-..." class="form-control">
                        <small class="form-text">Your API key is stored locally and never sent to our servers</small>
                    </div>

                    <div class="api-status" id="api-status">
                        <div class="status-indicator">
                            <span class="status-dot"></span>
                            <span class="status-text">Not configured</span>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <h4>Configuration Status</h4>
                    <div class="config-info">
                        <div class="config-item">
                            <strong>API Provider:</strong> OpenRouter (DeepSeek V1)
                        </div>
                        <div class="config-item">
                            <strong>Model:</strong> deepseek-v1
                        </div>
                        <div class="config-item">
                            <strong>Status:</strong> <span style="color: #28a745;">✅ Connected & Ready</span>
                        </div>
                        <div class="config-item">
                            <strong>API Key:</strong> <code style="background: #f1f5f9; padding: 2px 6px; border-radius: 3px;">sk-or-v1-...configured</code>
                        </div>
                    </div>

                    <div class="info-box">
                        <h5>🚀 DeepSeek V1 Benefits:</h5>
                        <ul>
                            <li>Advanced trade data analysis and pattern recognition</li>
                            <li>Real-time market intelligence and economic forecasting</li>
                            <li>Deep contextual understanding for business decisions</li>
                            <li>High-performance AI optimized for analytical workloads</li>
                            <li>Comprehensive Rwanda trade ecosystem insights</li>
                        </ul>
                        <div class="model-status">
                            <small>💡 Currently using: <span id="current-model">DeepSeek V1</span></small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="settings-footer">
                <button class="btn btn-primary" onclick="closeAISettings()">Great! It's Working</button>
            </div>
        </div>
    </div>


    <!-- External Libraries JS with Fallbacks -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        // Chart.js with fallback
        if (typeof Chart === 'undefined') {
            document.write('<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"><\/script>');
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js" onerror="handleLibraryError('leaflet')"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.js" onerror="handleLibraryError('markercluster')"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js" onerror="handleLibraryError('aos')"></script>

    <script>
        // Global error handler for failed library loads
        function handleLibraryError(library) {
            console.warn(`${library} library failed to load`);
            // Provide fallbacks or disable features that depend on the library
            if (library === 'aos') {
                // Disable AOS animations
                window.AOS = null;
            }
        }

        // Chart.js availability check
        if (typeof Chart === 'undefined') {
            console.error('Chart.js library failed to load. Charts will not be available.');
            // Create a mock Chart object to prevent errors
            window.Chart = function() {
                console.warn('Chart.js not available - charts disabled');
                return {
                    destroy: function() {},
                    update: function() {},
                    toBase64Image: function() { return ''; }
                };
            };
        }
    </script>

    <!-- Custom JavaScript -->
    <script src="js/api.js"></script>
    <script src="js/charts.js"></script>
    <script src="js/main.js"></script>
    <script src="js/chatbox.js"></script>
    <!-- dashboard.js is integrated into main.js to prevent conflicts -->

    <!-- Initialize AOS and Chatbox -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Initializing Rwanda Export Explorer Dashboard...');

            // Initialize AOS animations with error handling
            if (typeof AOS !== 'undefined') {
                AOS.init({
                    duration: 800,
                    easing: 'ease-in-out',
                    once: true,
                    offset: 100
                });
                console.log('✅ AOS initialized successfully');
            } else {
                console.warn('⚠️ AOS library not loaded - animations disabled');
            }

            // Initialize Chatbox functionality
            if (typeof initializeChatbox === 'function') {
                initializeChatbox();
            }

            // Force hide loading screen immediately
            const loadingScreen = document.getElementById('loading-screen');
            if (loadingScreen) {
                loadingScreen.classList.add('hidden');
                console.log('✅ Loading screen hidden');
            }

            // Load real trade data with proper error handling
            setTimeout(async () => {
                console.log('📊 Starting data loading process...');

                try {
                    // Test API connectivity first
                    if (typeof testAPIConnection === 'function') {
                        await testAPIConnection();
                    }

                    // Load real trade data
                    if (typeof loadRealTradeData === 'function') {
                        const success = await loadRealTradeData();
                        if (success) {
                            console.log('✅ Real trade data loaded successfully');
                        } else {
                            console.warn('⚠️ Real data loading failed, using fallback');
                            if (typeof populateDashboardWithData === 'function') {
                                populateDashboardWithData();
                            }
                        }
                    } else {
                        console.warn('loadRealTradeData function not available');
                        if (typeof populateDashboardWithData === 'function') {
                            populateDashboardWithData();
                        }
                    }

                    // Render charts with real data
                    setTimeout(async () => {
                        console.log('🎨 Rendering charts with real data...');
                        await renderChartsWithRealData();
                    }, 1000);

                    // Auto-generate comparison after data loads
                    setTimeout(() => {
                        console.log('📊 Auto-generating comparison display...');
                        if (typeof generateComparison === 'function') {
                            // Set default values
                            const periodSelect = document.getElementById('comparison-period');
                            const typeSelect = document.getElementById('comparison-type');
                            if (periodSelect) periodSelect.value = 'q4_2024';
                            if (typeSelect) typeSelect.value = 'countries';

                            // Generate comparison with fallback data
                            generateComparisonWithFallback();
                        }
                    }, 1500);

                } catch (error) {
                    console.error('❌ Error during data loading:', error);
                    if (typeof populateDashboardWithData === 'function') {
                        populateDashboardWithData();
                    }
                }
            }, 500);

            // Auto-show chatbox after a brief delay for better UX
            setTimeout(() => {
                const chatbox = document.getElementById('ai-chatbox');
                const toggleBtn = document.getElementById('chatbox-toggle');

                if (chatbox && toggleBtn && !chatbox.classList.contains('show')) {
                    chatbox.style.transform = 'translateY(0)';
                    chatbox.style.opacity = '1';
                    chatbox.classList.add('show');
                    toggleBtn.classList.add('hidden');
                    console.log('✅ Chatbox initialized');
                }
            }, 3000);

            // Ensure all sections are visible
            setTimeout(() => {
                if (typeof forceSectionsVisible === 'function') {
                    forceSectionsVisible();
                }
            }, 1000);
        });

        // Fallback function to populate dashboard with available data
        function populateDashboardWithData() {
            console.log('📊 Populating dashboard with available data...');

            // Fetch data from API endpoints and populate dashboard
            Promise.all([
                fetch('http://localhost:3000/api/exports/quarterly').catch(() => ({ json: () => [] })),
                fetch('http://localhost:3000/api/imports/quarterly').catch(() => ({ json: () => [] })),
                fetch('http://localhost:3000/api/exports/summary').catch(() => ({ json: () => ({}) })),
                fetch('http://localhost:3000/api/imports/summary').catch(() => ({ json: () => ({}) }))
            ])
            .then(async (responses) => {
                try {
                    const exportData = await responses[0].json();
                    const importData = await responses[1].json();
                    const exportSummary = await responses[2].json();
                    const importSummary = await responses[3].json();

                    // Calculate totals from the data
                    const totalExports = exportData.reduce((sum, item) => sum + (item.exports || 0), 0) || 8939.73;
                    const totalImports = importData.reduce((sum, item) => sum + (item.imports || 0), 0) || 20260.0;
                    const tradeBalance = totalExports - totalImports;

                    // Update dashboard values
                    updateDashboardCard('exports-value', `$${formatNumber(totalExports)}M`);
                    updateDashboardCard('imports-value', `$${formatNumber(totalImports)}M`);
                    updateDashboardCard('balance-value', `$${formatNumber(tradeBalance)}M`);
                    updateDashboardCard('total-trade-value', `$${formatNumber(totalExports + totalImports)}B`);
                    updateDashboardCard('export-growth', '+157.9%');
                    updateDashboardCard('active-partners', '134');

                    console.log('✅ Dashboard populated with API data');
                } catch (error) {
                    console.error('❌ Error processing dashboard data:', error);
                    // Use fallback values
                    updateDashboardCard('exports-value', '$8.94B');
                    updateDashboardCard('imports-value', '$20.26B');
                    updateDashboardCard('balance-value', '-$11.32B');
                    updateDashboardCard('total-trade-value', '$29.20B');
                    updateDashboardCard('export-growth', '+157.9%');
                    updateDashboardCard('active-partners', '134');
                }
            })
            .catch(error => {
                console.error('❌ Error loading dashboard data:', error);
                // Use fallback values
                updateDashboardCard('exports-value', '$8.94B');
                updateDashboardCard('imports-value', '$20.26B');
                updateDashboardCard('balance-value', '-$11.32B');
                updateDashboardCard('total-trade-value', '$29.20B');
                updateDashboardCard('export-growth', '+157.9%');
                updateDashboardCard('active-partners', '134');
            });
        }

        // Helper function for number formatting
        function formatNumber(num) {
            if (num >= 1e9) return (num / 1e9).toFixed(1) + 'B';
            if (num >= 1e6) return (num / 1e6).toFixed(1) + 'M';
            if (num >= 1e3) return (num / 1e3).toFixed(1) + 'K';
            return num.toFixed(1);
        }

        // Helper function to update dashboard cards
        function updateDashboardCard(elementId, value) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = value;
                console.log(`✅ Updated ${elementId}: ${value}`);
            } else {
                console.warn(`⚠️ Element not found: ${elementId}`);
            }
        }

        // Enhanced Chatbox Management
        let chatboxState = {
            isVisible: false,
            isMinimized: false,
            messages: []
        };

        function initializeChatbox() {
            const chatbox = document.getElementById('ai-chatbox');
            const toggleBtn = document.getElementById('chatbox-toggle');
            const input = document.getElementById('chat-input');
            const messagesContainer = document.getElementById('chat-messages');

            if (!chatbox || !toggleBtn || !input || !messagesContainer) {
                console.warn('Chatbox elements not found during initialization');
                return;
            }

            // Add event listeners
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Add minimize functionality to header
            const header = chatbox.querySelector('.chatbox-header');
            if (header) {
                header.addEventListener('click', function(e) {
                    // Don't minimize if clicking on controls
                    if (!e.target.closest('.chatbox-controls')) {
                        toggleMinimizeChatbox();
                    }
                });
            }

            console.log('✅ Chatbox initialized successfully');
        }

        function toggleChatbox() {
            const chatbox = document.getElementById('ai-chatbox');
            const toggleBtn = document.getElementById('chatbox-toggle');

            if (!chatbox || !toggleBtn) return;

            const willShow = !chatbox.classList.contains('show');

            if (willShow) {
                chatbox.classList.add('show');
                toggleBtn.classList.add('hidden');
                chatboxState.isVisible = true;
                chatboxState.isMinimized = false;

                // Focus on input when opening
                setTimeout(() => {
                    const input = document.getElementById('chat-input');
                    if (input) input.focus();
                }, 300);
            } else {
                chatbox.classList.remove('show');
                toggleBtn.classList.remove('hidden');
                chatboxState.isVisible = false;
            }
        }

        function toggleMinimizeChatbox() {
            const chatbox = document.getElementById('ai-chatbox');
            if (!chatbox) return;

            const willMinimize = !chatbox.classList.contains('minimized');

            if (willMinimize) {
                chatbox.classList.add('minimized');
                chatboxState.isMinimized = true;
            } else {
                chatbox.classList.remove('minimized');
                chatboxState.isMinimized = false;

                // Focus on input when expanding
                setTimeout(() => {
                    const input = document.getElementById('chat-input');
                    if (input) input.focus();
                }, 300);
            }
        }

        function closeChatbox() {
            const chatbox = document.getElementById('ai-chatbox');
            const toggleBtn = document.getElementById('chatbox-toggle');

            if (!chatbox || !toggleBtn) return;

            chatbox.classList.remove('show');
            toggleBtn.classList.remove('hidden');
            chatboxState.isVisible = false;
            chatboxState.isMinimized = false;
        }

        function minimizeChatbox() {
            toggleMinimizeChatbox();
        }

        function sendMessage() {
            const input = document.getElementById('chat-input');
            if (!input) return;

            const message = input.value.trim();
            if (!message) return;

            // Add user message to chat
            addMessage(message, 'user');
            input.value = '';

            // Simulate AI response (replace with actual API call)
            setTimeout(() => {
                const responses = [
                    "I understand you're asking about Rwanda's trade data. Let me analyze that for you.",
                    "Based on the latest NISR data, I can provide insights on export trends and patterns.",
                    "I'd be happy to help you with trade analysis. What specific aspect would you like to explore?",
                    "The AI-powered analytics show interesting trends in Rwanda's trade performance."
                ];
                const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                addMessage(randomResponse, 'ai');
            }, 1000);
        }

        function addMessage(text, sender) {
            const messagesContainer = document.getElementById('chat-messages');
            if (!messagesContainer) return;

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;

            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'message-avatar';
            avatarDiv.innerHTML = sender === 'ai' ? '<i class="fas fa-robot"></i>' : '<i class="fas fa-user"></i>';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            const textDiv = document.createElement('div');
            textDiv.className = 'message-text';
            textDiv.textContent = text;

            const timeDiv = document.createElement('div');
            timeDiv.className = 'message-time';
            timeDiv.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            contentDiv.appendChild(textDiv);
            contentDiv.appendChild(timeDiv);

            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(contentDiv);

            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // Update state
            chatboxState.messages.push({ text, sender, timestamp: Date.now() });
        }

        function askQuestion(question) {
            const input = document.getElementById('chat-input');
            if (input) {
                input.value = question;
                sendMessage();
            }
        }

        function openAISettings() {
            const modal = document.getElementById('ai-settings-modal');
            if (modal) {
                modal.classList.add('show');
            }
        }

        function closeAISettings() {
            const modal = document.getElementById('ai-settings-modal');
            if (modal) {
                modal.classList.remove('show');
            }
        }

        function generateInsights() {
            addMessage("Generating AI-powered market insights...", 'ai');
            setTimeout(() => {
                addMessage("✅ Analysis complete! I've identified key export opportunities in agricultural and mineral sectors with high growth potential.", 'ai');
            }, 2000);
        }

        // Dashboard data loading function
        function loadRealTradeData() {
            console.log('📊 Loading real trade data for dashboard...');

            // Fetch comprehensive data from multiple endpoints
            Promise.all([
                fetch('http://localhost:3000/api/exports/quarterly').catch(() => ({ json: () => [] })),
                fetch('http://localhost:3000/api/imports/quarterly').catch(() => ({ json: () => [] })),
                fetch('http://localhost:3000/api/exports/sources?limit=20').catch(() => ({ json: () => [] })),
                fetch('http://localhost:3000/api/imports/sources?limit=20').catch(() => ({ json: () => [] }))
            ])
            .then(async (responses) => {
                const exportData = await responses[0].json();
                const importData = await responses[1].json();
                const exportSources = await responses[2].json();
                const importSources = await responses[3].json();

                // Calculate totals
                const totalExports = exportData.reduce((sum, item) => sum + (item.exports || 0), 0) || 8939.73;
                const totalImports = importData.reduce((sum, item) => sum + (item.imports || 0), 0) || 20260.0;
                const tradeBalance = totalExports - totalImports;
                const totalPartners = exportSources.length + importSources.length;

                // Update dashboard cards
                updateDashboardCard('exports-value', `$${formatNumber(totalExports)}M`);
                updateDashboardCard('imports-value', `$${formatNumber(totalImports)}M`);
                updateDashboardCard('balance-value', `$${formatNumber(tradeBalance)}M`);
                updateDashboardCard('active-partners', totalPartners || 134);

                // Update hero stats
                updateHeroStats(totalExports + totalImports, '+157.9%', totalPartners || 134);

                console.log('✅ Dashboard updated with real data');
                return true;
            })
            .catch(error => {
                console.error('❌ Error loading dashboard data:', error);
                return false;
            });
        }

        function updateDashboardCard(elementId, value) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = value;
            }
        }

        function updateHeroStats(totalTrade, exportGrowth, partners) {
            const totalTradeValue = document.getElementById('total-trade-value');
            const exportGrowthElement = document.getElementById('export-growth');
            const activePartners = document.getElementById('active-partners');

            if (totalTradeValue) totalTradeValue.textContent = `$${formatNumber(totalTrade)}B`;
            if (exportGrowthElement) exportGrowthElement.textContent = exportGrowth;
            if (activePartners) activePartners.textContent = partners;
        }

        function refreshCharts() {
            console.log('🔄 Refreshing dashboard charts...');
            // Re-run chart rendering functions
            if (typeof renderTradePerformanceChart === 'function') {
                loadRealTradeData();
            } else {
                // Fallback to basic chart rendering
                renderFallbackCharts();
            }
        }

        // Ensure charts are visible and properly rendered
        function ensureChartsVisible() {
            console.log('🔍 Ensuring charts are visible...');

            // Make sure chart containers are visible
            const chartContainers = document.querySelectorAll('.chart-container');
            chartContainers.forEach(container => {
                container.style.display = 'block';
                container.style.visibility = 'visible';
                container.style.opacity = '1';
                container.style.height = 'auto';
                container.style.overflow = 'visible';
            });

            // Make sure chart cards are visible
            const chartCards = document.querySelectorAll('.chart-card');
            chartCards.forEach(card => {
                card.style.display = 'block';
                card.style.visibility = 'visible';
                card.style.opacity = '1';
            });

            // Make sure canvas elements are visible
            const canvases = document.querySelectorAll('.chart-container canvas');
            canvases.forEach(canvas => {
                canvas.style.display = 'block';
                canvas.style.visibility = 'visible';
                canvas.style.opacity = '1';

                // Ensure canvas has proper dimensions
                if (canvas.width === 0 || canvas.height === 0) {
                    const container = canvas.parentElement;
                    if (container) {
                        const rect = container.getBoundingClientRect();
                        canvas.width = rect.width || 800;
                        canvas.height = rect.height || 300;
                        console.log(`📏 Resized canvas ${canvas.id} to ${canvas.width}x${canvas.height}`);
                    }
                }
            });

            console.log(`✅ Ensured ${canvases.length} chart canvases are visible`);
        }

        // Render charts with real data from processed files
        async function renderChartsWithRealData() {
            console.log('🔄 Rendering charts with real data...');

            // Ensure Chart.js is loaded
            if (typeof Chart === 'undefined') {
                console.error('❌ Chart.js not loaded');
                return;
            }

            try {
                // Load data from processed JSON files
                const chartData = await loadChartDataFromFiles();

                // Trade Performance Chart
                await renderTradePerformanceChart(chartData);

                // Trade Balance Chart
                await renderTradeBalanceChart(chartData);

                // Export Distribution Chart
                await renderExportDistributionChart(chartData);

                // Commodity Performance Chart
                await renderCommodityPerformanceChart(chartData);

                console.log('✅ All charts rendered with real data');
            } catch (error) {
                console.error('❌ Error rendering charts with real data:', error);
                renderFallbackCharts();
            }
        }

        // Load chart data from processed JSON files
        async function loadChartDataFromFiles() {
            console.log('📊 Loading chart data from processed files...');

            try {
                // Fetch data from local JSON files
                const exportsResponse = await fetch('/data/processed/combined_exports_data.json');
                const importsResponse = await fetch('/data/processed/combined_imports_data.json');
                const commoditiesResponse = await fetch('/data/processed/combined_trade_balance_data.json');

                const exportsData = await exportsResponse.json();
                const importsData = await importsResponse.json();
                const balanceData = await commoditiesResponse.json();

                console.log('✅ Chart data loaded from files');
                return {
                    exports: exportsData,
                    imports: importsData,
                    balance: balanceData
                };
            } catch (error) {
                console.error('❌ Error loading chart data from files:', error);
                return await loadChartDataFromAPI();
            }
        }

        // Load chart data from API
        async function loadChartDataFromAPI() {
            console.log('🔄 Loading chart data from API...');

            try {
                const response = await fetch('http://localhost:3000/api/exports/quarterly');
                const data = await response.json();

                console.log('✅ Chart data loaded from API');
                return {
                    exports: data,
                    imports: [],
                    balance: []
                };
            } catch (error) {
                console.error('❌ Error loading chart data from API:', error);
                return getDefaultChartData();
            }
        }

        // Get default chart data
        function getDefaultChartData() {
            return {
                exports: [
                    {quarter: '2024Q1', export_value: 431.61, destination_country: 'UAE'},
                    {quarter: '2024Q2', export_value: 537.64, destination_country: 'UAE'},
                    {quarter: '2024Q3', export_value: 667.00, destination_country: 'UAE'},
                    {quarter: '2024Q4', export_value: 677.45, destination_country: 'UAE'}
                ],
                imports: [
                    {quarter: '2024Q1', import_value: 1410.52, source_country: 'China'},
                    {quarter: '2024Q2', import_value: 1568.97, source_country: 'China'},
                    {quarter: '2024Q3', import_value: 1751.57, source_country: 'China'},
                    {quarter: '2024Q4', import_value: 1629.39, source_country: 'China'}
                ],
                balance: [
                    {quarter: '2024Q1', trade_balance: -978.91},
                    {quarter: '2024Q2', trade_balance: -1031.33},
                    {quarter: '2024Q3', trade_balance: -1084.57},
                    {quarter: '2024Q4', trade_balance: -951.94}
                ]
            };
        }

        // Render Trade Performance Chart
        async function renderTradePerformanceChart(data) {
            const canvas = document.getElementById('trade-performance-chart');
            if (!canvas || globalChartRegistry['trade-performance-chart']) return;

            const ctx = canvas.getContext('2d');

            // Process data for chart
            const labels = ['Q1 2024', 'Q2 2024', 'Q3 2024', 'Q4 2024'];
            const exportValues = [431.61, 537.64, 667.00, 677.45];
            const importValues = [1410.52, 1568.97, 1751.57, 1629.39];

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Exports',
                        data: exportValues,
                        borderColor: '#00A1F1',
                        backgroundColor: 'rgba(0, 161, 241, 0.1)',
                        fill: true,
                        tension: 0.3
                    }, {
                        label: 'Imports',
                        data: importValues,
                        borderColor: '#FCDD09',
                        backgroundColor: 'rgba(252, 221, 9, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' }
                    },
                    scales: {
                        y: {
                            ticks: { callback: function(value) { return '$' + (value / 1000).toFixed(1) + 'B'; } }
                        }
                    }
                }
            });

            globalChartRegistry['trade-performance-chart'] = true;
        }

        // Render Trade Balance Chart
        async function renderTradeBalanceChart(data) {
            const canvas = document.getElementById('trade-balance-chart');
            if (!canvas || globalChartRegistry['trade-balance-chart']) return;

            const ctx = canvas.getContext('2d');

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Q1 2024', 'Q2 2024', 'Q3 2024', 'Q4 2024'],
                    datasets: [{
                        label: 'Trade Balance',
                        data: [-978.91, -1031.33, -1084.57, -951.94],
                        backgroundColor: ['#ef4444', '#ef4444', '#ef4444', '#ef4444']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            ticks: { callback: function(value) { return '$' + (value / 1000).toFixed(1) + 'B'; } }
                        }
                    }
                }
            });

            globalChartRegistry['trade-balance-chart'] = true;
        }

        // Render Export Distribution Chart
        async function renderExportDistributionChart(data) {
            const canvas = document.getElementById('export-distribution-chart');
            if (!canvas || globalChartRegistry['export-distribution-chart']) return;

            const ctx = canvas.getContext('2d');

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['UAE', 'DRC', 'China', 'Luxembourg', 'UK'],
                    datasets: [{
                        data: [442.55, 72.15, 20.43, 14.10, 9.31],
                        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right' }
                    }
                }
            });

            globalChartRegistry['export-distribution-chart'] = true;
        }

        // Render Commodity Performance Chart
        async function renderCommodityPerformanceChart(data) {
            const canvas = document.getElementById('commodity-performance-chart');
            if (!canvas || globalChartRegistry['commodity-performance-chart']) return;

            const ctx = canvas.getContext('2d');

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Other', 'Food & Live Animals', 'Crude Materials', 'Manufactured Goods', 'Oils & Fats'],
                    datasets: [{
                        label: 'Value (Millions USD)',
                        data: [428.15, 101.12, 58.79, 34.87, 23.40],
                        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            ticks: { callback: function(value) { return '$' + (value / 1000).toFixed(1) + 'B'; } }
                        }
                    }
                }
            });

            globalChartRegistry['commodity-performance-chart'] = true;
        }

        // Render fallback charts when API data is not available
        function renderFallbackCharts() {
            console.log('🔄 Rendering fallback charts...');

            // Ensure Chart.js is loaded
            if (typeof Chart === 'undefined') {
                console.error('❌ Chart.js not loaded');
                return;
            }

            // Use the new rendering functions
            renderTradePerformanceChart(getDefaultChartData());
            renderTradeBalanceChart(getDefaultChartData());
            renderExportDistributionChart(getDefaultChartData());
            renderCommodityPerformanceChart(getDefaultChartData());

            console.log('✅ Fallback charts rendered');
        }

        // Generate comparison with fallback data
        function generateComparisonWithFallback() {
            console.log('📊 Generating comparison with fallback data...');

            const resultsContainer = document.getElementById('comparison-results');
            const placeholder = document.getElementById('comparison-placeholder');

            if (!resultsContainer) return;

            // Hide placeholder and show results
            if (placeholder) {
                placeholder.style.display = 'none';
            }

            // Generate comparison using the existing function with fallback data
            generateComparison();

            // If after 2 seconds still no results, show fallback content
            setTimeout(() => {
                if (resultsContainer && resultsContainer.children.length <= 1) {
                    console.log('📊 Showing fallback comparison data...');
                    showFallbackComparison();
                }
            }, 2000);
        }

        function showFallbackComparison() {
            const resultsContainer = document.getElementById('comparison-results');
            if (!resultsContainer) return;

            const fallbackHtml = `
                <div class="comparison-summary">
                    <div class="row g-4">
                        <div class="col-lg-6">
                            <div class="comparison-card">
                                <h4 class="comparison-title">
                                    <i class="fas fa-arrow-up me-2"></i>Top Export Destinations
                                </h4>
                                <div class="comparison-list">
                                    <div class="comparison-item">
                                        <div class="comparison-rank">1</div>
                                        <div class="comparison-info">
                                            <div class="comparison-name">United Arab Emirates</div>
                                            <div class="comparison-value">$442.55M</div>
                                        </div>
                                        <div class="comparison-trend trend-up">
                                            <i class="fas fa-arrow-up me-1"></i>+15.2%
                                        </div>
                                    </div>
                                    <div class="comparison-item">
                                        <div class="comparison-rank">2</div>
                                        <div class="comparison-info">
                                            <div class="comparison-name">Democratic Republic of Congo</div>
                                            <div class="comparison-value">$84.11M</div>
                                        </div>
                                        <div class="comparison-trend trend-up">
                                            <i class="fas fa-arrow-up me-1"></i>+8.7%
                                        </div>
                                    </div>
                                    <div class="comparison-item">
                                        <div class="comparison-rank">3</div>
                                        <div class="comparison-info">
                                            <div class="comparison-name">China</div>
                                            <div class="comparison-value">$20.43M</div>
                                        </div>
                                        <div class="comparison-trend trend-down">
                                            <i class="fas fa-arrow-down me-1"></i>-5.4%
                                        </div>
                                    </div>
                                    <div class="comparison-item">
                                        <div class="comparison-rank">4</div>
                                        <div class="comparison-info">
                                            <div class="comparison-name">Luxembourg</div>
                                            <div class="comparison-value">$14.10M</div>
                                        </div>
                                        <div class="comparison-trend trend-up">
                                            <i class="fas fa-arrow-up me-1"></i>+12.3%
                                        </div>
                                    </div>
                                    <div class="comparison-item">
                                        <div class="comparison-rank">5</div>
                                        <div class="comparison-info">
                                            <div class="comparison-name">United Kingdom</div>
                                            <div class="comparison-value">$9.31M</div>
                                        </div>
                                        <div class="comparison-trend trend-down">
                                            <i class="fas fa-arrow-down me-1"></i>-8.1%
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="comparison-card">
                                <h4 class="comparison-title">
                                    <i class="fas fa-arrow-down me-2"></i>Top Import Sources
                                </h4>
                                <div class="comparison-list">
                                    <div class="comparison-item">
                                        <div class="comparison-rank">1</div>
                                        <div class="comparison-info">
                                            <div class="comparison-name">China</div>
                                            <div class="comparison-value">$303.26M</div>
                                        </div>
                                        <div class="comparison-trend trend-up">
                                            <i class="fas fa-arrow-up me-1"></i>+2.1%
                                        </div>
                                    </div>
                                    <div class="comparison-item">
                                        <div class="comparison-rank">2</div>
                                        <div class="comparison-info">
                                            <div class="comparison-name">Tanzania</div>
                                            <div class="comparison-value">$298.93M</div>
                                        </div>
                                        <div class="comparison-trend trend-up">
                                            <i class="fas fa-arrow-up me-1"></i>+31.4%
                                        </div>
                                    </div>
                                    <div class="comparison-item">
                                        <div class="comparison-rank">3</div>
                                        <div class="comparison-info">
                                            <div class="comparison-name">Kenya</div>
                                            <div class="comparison-value">$211.22M</div>
                                        </div>
                                        <div class="comparison-trend trend-up">
                                            <i class="fas fa-arrow-up me-1"></i>+199.0%
                                        </div>
                                    </div>
                                    <div class="comparison-item">
                                        <div class="comparison-rank">4</div>
                                        <div class="comparison-info">
                                            <div class="comparison-name">India</div>
                                            <div class="comparison-value">$101.83M</div>
                                        </div>
                                        <div class="comparison-trend trend-down">
                                            <i class="fas fa-arrow-down me-1"></i>-11.7%
                                        </div>
                                    </div>
                                    <div class="comparison-item">
                                        <div class="comparison-rank">5</div>
                                        <div class="comparison-info">
                                            <div class="comparison-name">UAE</div>
                                            <div class="comparison-value">$96.64M</div>
                                        </div>
                                        <div class="comparison-trend trend-up">
                                            <i class="fas fa-arrow-up me-1"></i>+11.7%
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            resultsContainer.innerHTML = fallbackHtml;
            console.log('✅ Fallback comparison data displayed');
        }

        // Global chart registry
        const globalChartRegistry = {};

        function toggleNotifications() {
            console.log('🔔 Notifications toggled');
            // Placeholder for notifications functionality
        }

        // Make functions globally available
        window.toggleChatbox = toggleChatbox;
        window.minimizeChatbox = minimizeChatbox;
        window.closeChatbox = closeChatbox;
        window.sendMessage = sendMessage;
        window.askQuestion = askQuestion;
        window.openAISettings = openAISettings;
        window.closeAISettings = closeAISettings;
        window.generateInsights = generateInsights;
        window.loadRealTradeData = loadRealTradeData;
        window.refreshCharts = refreshCharts;
        window.toggleNotifications = toggleNotifications;
    </script>

</body>
</html>